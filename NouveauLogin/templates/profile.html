<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    
    <title>Document</title>
	<script>
		// ENV
	var searchPageCallback = null;
	var isProfile = {{ on_profile }};

	var msg_delAllTag = "Etes vous sûr de vouloir supprimer tout les tags de la recherche ?";
	var msg_requestError = "Une erreur est survenu lors du chargement des ressources, vérifiez votre connection et réesseyez";
	var msg_deleteTag = "Etes vous sûr de vouloir supprimer définitivement ce tag ? le tag sera retiré de toutes les questions de votre profil";
	var msg_deleteQuestion = "Etes vous sûr de vouloir supprimer définitivement cette question ?";
	var msg_deleteDocument = "Etes vous sûr de vouloir supprimer définitivement ce document ?";

	// form 

	var doc_request = [];
	var question_request = [];
	var tag_request = [];
	
	// SMOOTH ALERT
	var f_alert = false;
	function smooth_alert(msg, color) {
		f_alert = true;
		let el = document.getElementById("smoothAlert");
		document.getElementById("sm_message").innerHTML = msg;
		el.className = "smoothAlertOn";
		el.style.display = "block";
		el.setAttribute("style", "background-color: " + color);
		

		setTimeout(() => {
			f_alert = false;
			el.className = "smoothAlert";
			setTimeout(() => {
				if (f_alert == false) {
					el.style.display = "none";
				}
			}, 1000);
		}, 5000);
	}

	// SERVER REQUEST
	function request_changePassword() {
		let el = document.getElementById("pf_result");
		fetch("/newPassword", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({password: document.getElementById("pf_password").value, newpassword: document.getElementById("pf_newpassword").value})
		}).then((response) => {
		  	if (response.ok) {
				el.style = "color: green;";
				el.innerHTML = "Mot de passe changé avec succès !";
			}
			else {
				el.style = "color: yellow;";
				el.innerHTML = "Le mot de passe n'a pas été changé correctement, vérifiez que votre mot de passe entré est correct";
			}
		}).catch((error) => {
			console.log(error);
			el.style = "color: red;";
			el.innerHTML = msg_requestError;
		});
	}

	function request_updateTag(callback) {
		fetch("/profileTag/{{ visit_id }}")
		.then((response) => {
			if (response.ok) {
	  			return response.json();
			}
	  	}).then((response) => {
			tag_request = response;
			callback();
		}).catch( (error) => {
			console.log(error);
			smooth_alert(msg_requestError, "red");
		});
	}
	
  	function request_createTag(callback, tagname) {
	  	fetch("/newProfileTag", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({tag: tagname})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Tag créer avec succès", "green");
				callback();
			}
			else {
				smooth_alert("Ce tag est invalide ou existe déjà", "orange");
			}
		  }).catch((error) => {
			console.log(error);
			smooth_alert(msg_requestError, "red");
		  });
  	}

	function request_setTagsToQuestion(questionId, tagsname) {
		fetch("/setQuestionTags", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({id:questionId, tags: tagsname})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Tags ajoutés avec succès", "green");
			}
			else {
				smooth_alert("Certains tags n'ont pas pu être ajouté à la base de donnée", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
		  });
  	}

	function request_destroyTag(callback, tagname) {
		fetch("/deleteProfileTag", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({tag: tagname})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Tag supprimé avec succès", "green");
				callback();
			}
			else {
				smooth_alert("Ce tag n'a pas pu être détruit", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
		  });
	}


	function request_getQuestionInfo(questionId, callback) {
		fetch("/QuestionInfo", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({id: questionId})
		  }).then((response) => {
			if (response.ok) {
	  			return response.json();
			}
	  	}).then((response) => {
				callback(response);
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
			console.log(error);
		  });
	}

	function request_updateQuestion(callback) {
		fetch("/profileQuestionInfo/{{ visit_id }}")
		.then((response) => {
			if (response.ok) {
	  			return response.json();
			}
	  	}).then((response) => {
			question_request = response;
			callback();
		}).catch( (error) => {
			console.log(error);
			smooth_alert(msg_requestError, "red");
		});
	}


	function request_createQuestion(callback, l_title, l_type, l_visibility) {
		fetch("/newQuestion", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({title: l_title, type: l_type, visibility: l_visibility})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Question créer avec succès", "green");
				callback();
			}
			else {
				smooth_alert("La question n'a pas pu être créer, vérifiez à ce que les paramêtres n'excède pas la taille recommandée", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
			console.log(error);
		  });
  	}

	function request_destroyQuestion(callback, questionId) {
		fetch("/deleteQuestion", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({id: questionId})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Question supprimée avec succès", "green");
				callback();
			}
			else {
				smooth_alert("Cette question n'a pas pu être détruite", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
		  });
	}

	function request_shareQuestionAccessToUser(questionId, usrId, writing) {
		fetch("/newProfileTag", {
			method: 'POST',
			headers: {
			'Content-Type': 'application/json'
			},
			credentials: 'same-origin',
			body: JSON.stringify({tag: tagsname})
		}).then((response) => {
			if (response.ok) {
				l_element.appendChild(document.textContent("Tags ajouté avec succès"));
				smooth_alert("Question supprimée avec succès", "green");
			}
			else {
				smooth_alert("La question n'a pas pu être supprimée", "orange");
			}
		}).catch((error) => {
			smooth_alert(msg_requestError, "red");
		});
  	}

	function request_removeQuestionAccessToUser(tagname) {
	  	fetch("/newProfileTag", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({tag: tagname})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Tag créer avec succès", "green");
			}
			else {
				smooth_alert("Ce tag existe déjà", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
		  });
  	}

	// DOCUMENT
	function request_getDocumentInfo(documentId, callback) {
		fetch("/DocumentInfo", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({id: documentId})
		  }).then((response) => {
			if (response.ok) {
	  			return response.json();
			}
	  	}).then((response) => {
				callback(response);
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
		  });
	}

	function request_updateDocument(callback) {
		fetch("/profileDocumentInfo/{{ visit_id }}")
		.then((response) => {
			if (response.ok) {
	  			return response.json();
			}
	  	}).then((response) => {
			doc_request = response;
			callback();
		}).catch( (error) => {
			console.log(error);
			smooth_alert(msg_requestError, "red");
		});
	}

	function request_createDocument(callback, l_title, l_visibility) {
		fetch("/newDocument", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({title: l_title, visibility: l_visibility})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Document créer avec succès", "green");
				callback();
			}
			else {
				smooth_alert("Le document n'a pas pu être créer, vérifiez à ce que les paramêtres n'excède pas la taille recommandée", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
			console.log(error);
		  });
  	}

	
	  function request_destroyDocument(callback, questionId) {
		fetch("/deleteDocument", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({id: questionId})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Document supprimée avec succès", "green");
				callback();
			}
			else {
				smooth_alert("Ce document n'a pas pu être détruit", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
		  });
	}

	function request_addQuestionToDocument(l_questId, l_docId) {
		fetch("/addQuestionToDocument", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({idQuestion: l_questId, idDocument: l_docId})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Question ajouté avec succès", "green");
				loadQuestionsPage(); // A CHANGER
				updateDocumentSearch();
			}
			else {
				smooth_alert("La question n'a pas pu être ajouté correctement", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
			console.log(error);
		  });
	}

	function request_removeQuestionFromDocument(l_questId, l_docId) {
		fetch("/removeQuestionFromDocument", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({idQuestion: l_questId, idDocument: l_docId})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Question retiré du document avec succès", "green");
				callback();
			}
			else {
				smooth_alert("La question n'a pas pu être retiré du document", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
		  });
	}
	
	function request_shareDocumentAccessToUser(questionId, usrId, writing) {
		fetch("/newProfileTag", {
			method: 'POST',
			headers: {
			'Content-Type': 'application/json'
			},
			credentials: 'same-origin',
			body: JSON.stringify({tag: tagsname})
		}).then((response) => {
			if (response.ok) {
				l_element.appendChild(document.textContent("Tags ajouté avec succès"));
				smooth_alert("Question supprimée avec succès", "green");
			}
			else {
				smooth_alert("La question n'a pas pu être supprimée", "orange");
			}
		}).catch((error) => {
			smooth_alert(msg_requestError, "red");
		});
  	}

	function request_removeDocumentAccessToUser(tagname) {
	  	fetch("/newProfileTag", {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json'
		    },
		    credentials: 'same-origin',
		    body: JSON.stringify({tag: tagname})
		  }).then((response) => {
		  	if (response.ok) {
				smooth_alert("Tag créer avec succès", "green");
			}
			else {
				smooth_alert("Ce tag existe déjà", "orange");
			}
		  }).catch((error) => {
			smooth_alert(msg_requestError, "red");
		  });
  	}

	// GRAPHICAL
	function fadebuttonColor(elem) {
		for(let d of document.getElementsByClassName("persistentButtonOn")) {
			d.className = "persistentButton";
		}

		for(let d of document.getElementsByClassName("persistentButton")) {
			if (d == elem) {
				d.className = "persistentButtonOn";
			}
		}
	}

	function updateHeightNavBar() {
		document.body.style.paddingTop = (document.getElementById("navbar").offsetHeight + document.getElementById("tagListPage").offsetHeight + 40).toString() + "px";
	}

	function unrollTagList(el, tagListPageId, callback) {
		el.className = "searchTagButtonRotate";
		el.setAttribute("onClick", "rollTagList(this,'" + tagListPageId + "', '" + callback + "');" + callback);
		document.getElementById(tagListPageId).style.display = "block";
	}

	function rollTagList(el, tagListPageId, callback) {
		el.className = "searchTagButton";
		el.setAttribute("onClick", "unrollTagList(this, '" + tagListPageId + "', '" + callback + "');" + callback);
		document.getElementById(tagListPageId).style.display = "none";
	}

	// SEARCH BAR
	var searchTagList = [];
	var searchDocumentId = null;
	var searchDocumentQuestion = [];
	var searchDiffusion = [];

	function updateDocumentSearch() {
		if (searchDocumentId != null) {
			request_getDocumentInfo(searchDocumentId, (data) => {
				searchDocumentQuestion = [];
				for(let i of data["questions"]) {
					searchDocumentQuestion.push(i["id"]);
				}
				if (searchPageCallback != null) {
					searchPageCallback();
				}
			});
		}
	}

	function setDocumentSelect(documentId, documentTitle) {
		searchDocumentId = documentId;
		let t_s = document.getElementById("documentSelected");
		t_s.innerHTML = "";

		request_updateDocument(() => {
			updateDocumentsListPage();
		});

		if (searchDocumentId == null) {
			searchDocumentQuestion = [];
			t_s.innerHTML = "Aucun document sélectionné pour le moment";
		}
		else {
			t_s.appendChild(document.createTextNode(documentTitle));
			let nbtDel = document.createElement("button");
			nbtDel.setAttribute("onClick", "setDocumentSelect(null, null);");
			nbtDel.appendChild(document.createTextNode("remove"));
			t_s.appendChild(nbtDel);

			updateDocumentSearch();
		}
	}

	function createTagNode(tagId, onDestroy, onAdd) {
		let nel = document.createElement("div");
		nel.className = "tagSearch";

		if (onAdd != null) {
			let nbtAdd = document.createElement("button");
			nbtAdd.setAttribute("onClick", onAdd);
			nbtAdd.appendChild(document.createTextNode("+"));
			nel.appendChild(nbtAdd);
		}

		nel.appendChild(document.createTextNode(tagId));

		if (onDestroy != null) {
			let nbtDel = document.createElement("button");
			nbtDel.setAttribute("onClick", onDestroy);
			nbtDel.appendChild(document.createTextNode("X"));
			nel.appendChild(nbtDel);
		}

		return nel;
	}

	function updateTagSearchList() {
		let el = document.getElementById("tagListPage");
		el.innerHTML = "";
		for(let t of searchTagList) {
			el.appendChild(createTagNode(t, "removeTagSearch(\'" + t + "\');", null));
		}
		if(searchTagList.length == 0) {
			el.appendChild(document.createTextNode("Aucun tag pour l'instant"));
		}

		if (searchPageCallback != null) {
			searchPageCallback();
		}

		updateHeightNavBar();
	}

	function addTagSearch(tagStr) {
		if(!searchTagList.includes(tagStr)) {
			searchTagList.push(tagStr);
			updateTagSearchList();
			return true;
		}
		return false;
	}

	function removeTagSearch(tagStr) {
		let index = searchTagList.indexOf(tagStr);
		if (index > -1) {
			searchTagList.splice(index, 1);
			updateTagSearchList();
		}
	}

	function replaceTagSearch(l_tagList) {
		searchTagList = l_tagList;
		updateTagSearchList();
	}

	// POP UP
	// POP UP CONFIRM
	function showPopUpConfirm(callbackStr, message) {
		document.getElementById("PUWConfirm").style.display = "block";
		document.getElementById("PUMConfirm").innerHTML = message;
		document.getElementById("PUBConfirm").setAttribute("onClick", "hidePopUpConfirm();" + callbackStr);
	}

	function hidePopUpConfirm() {
		document.getElementById("PUWConfirm").style.display = "none";
		document.getElementById("tagCreator").style.display = "none";
		document.getElementById("docCreator").style.display = "none";
		document.getElementById("questionCreator").style.display = "none";
		document.getElementById("diffusionCreator").style.display = "none";
	}

	// SUB POP UP CONFIRM
	function showPopUpConfirmTagCreation(callbackStr) {
		document.getElementById("tagCreator").style.display = "block";
		showPopUpConfirm(callbackStr, "<h3>Création d'un nouveau tag</h3>");
	}

	function showPopUpConfirmQuestionCreation(callbackStr) {
		document.getElementById("questionCreator").style.display = "block";
		showPopUpConfirm(callbackStr, "<h3>Création d'une nouvelle question</h3>");
	}

	function showPopUpConfirmDocCreation(callbackStr) {
		document.getElementById("docCreator").style.display = "block";
		showPopUpConfirm(callbackStr, "<h3>Création d'un nouveau document</h3>");
	}

	function showPopUpConfirmDiffusionCreation(callbackStr){
		document.getElementById("diffusionCreator").style.display = "block";
		showPopUpConfirm(callbackStr, "<h3>Nouvelle diffusion de questions</h3>");
	}

	// POP UP PROFILE
	function showPopUpProfile() {
		document.getElementById("PUWProfile").style.display = "block";
	}

	function hidePopUpProfile() {
		document.getElementById("PUWProfile").style.display = "none";
		document.getElementById("pf_result").innerHTML = "";
	}


	// POP UP TAG SELECTOR
	var selectorTagList = [];

	function updateTagSelectorList() {
		let el = document.getElementById("selectTagList");
		el.innerHTML = "";

		for(let t of selectorTagList) {
			el.appendChild(createTagNode(t, "removeTagSelector(\'" + t + "\')", null));
		}

		if(selectorTagList.length == 0) {
			el.appendChild(document.createTextNode("Aucun tag pour l'instant"));
		}
	}

	function addTagSelector(tagStr) {
		if(!selectorTagList.includes(tagStr)) {
			selectorTagList.push(tagStr);
			updateTagSelectorList();
			return true;
		}
		return false;
	}

	function removeTagSelector(tagStr) {
		let index = selectorTagList.indexOf(tagStr);
		if (index > -1) {
			selectorTagList.splice(index, 1);
			updateTagSelectorList();
		}
	}

	function replaceTagSelect(tagList) {
		selectorTagList = tagList;
		updateTagSelectorList();
	}

	function showPopUpTag(alreadySelected, canCreateTag, callbackStr) {
		for (let i in alreadySelected) {
			selectorTagList[i] = alreadySelected[i]; // DEEP COPY
		}
		document.getElementById("PUWTag").style.display = "block";
		document.getElementById("PUCTag").setAttribute("onClick", "hidePopUpTag();" + callbackStr);
		updateTagSelectorList();
		unrollTagList(document.getElementById("selectTagButton"), "selectTagList", "");
	}

	function hidePopUpTag() {
		document.getElementById("PUWTag").style.display = "none";
	}


	// POP UP QUESTION
	function showPopUpQuestion(questionId) {
		document.getElementById("PUWQuestion").style.display = "block";

		t_title = document.getElementById("PUTitleQuestion");
		t_visibility = document.getElementById("PUVisibilityQuestion");
		t_actions = document.getElementById("PUQuestionAction");
		t_tags = document.getElementById("PULTagsQuestion");
		t_collab = document.getElementById("PULCollabQuestion");
		t_title.innerHTML = "";
		t_visibility.innerHTML = "";
		t_tags.innerHTML = "";
		t_collab.innerHTML = "";
		t_actions.innerHTML = "";

		request_getQuestionInfo(questionId, (data) => {
			t_title.appendChild(document.createTextNode(data["title"]));
			t_visibility.appendChild(document.createTextNode(data["visibility"]));

			// ACTIONS
			let nbtSee = document.createElement("a");
			nbtSee.setAttribute("href", "/VisualiseQuestion/" + questionId);
			nbtSee.appendChild(document.createTextNode("visualiser le fichier"));
			t_actions.appendChild(nbtSee);

			if(data["writing"]) {
				let nbtw = document.createElement("a");
				nbtw.setAttribute("href", "/Edit/" + questionId);
				nbtw.appendChild(document.createTextNode("modifier le fichier"));
				t_actions.appendChild(nbtw);
			}

			if (isProfile) {
				let nbm = document.createElement("button");
				nbm.setAttribute("onClick", ""); // SHOW UP TAG SELECTOR
				nbm.appendChild(document.createTextNode("ajouter des tags"));
				t_actions.appendChild(nbm);
			}

			for(let d of data["tags"]) {

			}

			for(let d of data["usr"]) {

			}

		});
	}

	function hidePopUpQuestion() {
		document.getElementById("PUWQuestion").style.display = "none";
	}

	// POP UP DOCUMENT
	function showPopUpDocument(documentId) {
		document.getElementById("PUWDocument").style.display = "block";
	}

	function hidePopUpDocument() {
		document.getElementById("PUWDocument").style.display = "none";
	}


	// PAGE LOADER
	function changePage(pageId) {
  		for(let el of document.getElementsByClassName("dynamicpage")) {
  			if(el.id == pageId) {
  				el.style.display = "block";
  			}
  			else {
  				el.style.display = "none";
  			}
  		}
  	}

	function updateTagsListPage() {
		let obj = document.getElementById("tagPageList");
		obj.innerHTML = "";
		for(tag of tag_request) {
			if (tag.startsWith(document.getElementById("searchTagPage").value)) {
				let t_inc = searchTagList.includes(tag);
				let t_add = "addTagSearch(\'" + tag + "\')";

				if(t_inc) {
					t_add = null;
				}

				let el = null;
				if (isProfile) {
					el = createTagNode(tag, "showPopUpConfirm(\"request_destroyTag(loadTagsPage, \'" + tag + "\')\", msg_deleteTag);", t_add);
				}
				else {
					el = createTagNode(tag, null, t_add);
				}

				if (t_inc) {
					el.style.backgroundColor = "rgb(173,216,230)";
				}

				obj.appendChild(el);
			}
		}

		if (obj.innerHTML == "") {
			obj.appendChild(document.createTextNode("Aucun tag pour l'instant"));
		}
	}

	// DOCUMENT
	function setDocNull() {
		setDocumentSelect(null, null);

	}

	function createDocumentNode(docId, docTitle, docVisibility, l_canSelect) {
		let nel = document.createElement("div");
		//nel.className = "tagSearch";

		if (l_canSelect) {
			let nbtAdd = document.createElement("button");
			nbtAdd.setAttribute("onClick", "setDocumentSelect(\'" + docId + "\', \'" + docTitle + "\');");
			nbtAdd.appendChild(document.createTextNode("+"));
			nel.appendChild(nbtAdd);
		}

		let nbtSee = document.createElement("button");
		nbtSee.setAttribute("onClick", "showPopUpDocument(\'" + docId + "\');");
		nbtSee.appendChild(document.createTextNode("info"));
		nel.appendChild(nbtSee);
		
		if(isProfile) {
			let nbtDel = document.createElement("button");
			if (l_canSelect) {
				nbtDel.setAttribute("onClick", "showPopUpConfirm(\"request_destroyDocument(loadDocumentsPage, \'" + docId + "\')\", msg_deleteDocument);");
			}
			else {
				nbtDel.setAttribute("onClick", "showPopUpConfirm(\"request_destroyDocument(setDocNull, \'" + docId + "\')\", msg_deleteDocument);"); // setDocumentSelect(null, null)
			}

			nbtDel.appendChild(document.createTextNode("del"));
			nel.appendChild(nbtDel);
		}

		nel.append(document.createTextNode(docVisibility + " ---- "));
		nel.append(document.createTextNode(docTitle));
		
		return nel;
	}

	function updateDocumentsListPage() {
		let obj = document.getElementById("documentsPageList");
		obj.innerHTML = "";
		for(doc of doc_request) {
			if (doc["title"].startsWith(document.getElementById("searchTagPage").value)) {
				let el = null;
				if (isProfile) {
					el = createDocumentNode(doc["id"], doc["title"], doc["visibility"], true);
					if (doc["id"] != searchDocumentId) {
						el = createDocumentNode(doc["id"], doc["title"], doc["visibility"], true);
					}
					else {
						el = createDocumentNode(doc["id"], doc["title"], doc["visibility"], false);
						el.style.backgroundColor = "rgb(173,216,230)";
					}
				}
				else {
					el = createDocumentNode(doc["id"], doc["title"], doc["visibility"], false);
				}

				obj.appendChild(el);
			}
		}

		if (obj.innerHTML == "") {
			obj.appendChild(document.createTextNode("Aucun document pour l'instant"));
		}
	}


	// QUESTION PAGE
	function createQuestionNode(questId, questTitle, questVisibility, addCallback, delCallback) {
		let nel = document.createElement("div");
		//nel.className = "tagSearch";

		if (addCallback != null) {
			let nbtAdd = document.createElement("button");
			nbtAdd.setAttribute("onClick", addCallback);
			nbtAdd.appendChild(document.createTextNode("+"));
			nel.appendChild(nbtAdd);
		}

		let nbtInfo = document.createElement("button");
		nbtInfo.setAttribute("onClick", "showPopUpQuestion(\'" + questId + "\');");
		nbtInfo.appendChild(document.createTextNode("info"));
		nel.appendChild(nbtInfo);

		if (delCallback != null) {
			let nbtDel = document.createElement("button");
			nbtDel.setAttribute("onClick", delCallback);
			nbtDel.appendChild(document.createTextNode("del"));
			nel.appendChild(nbtDel);
		}
		
		nel.append(document.createTextNode(questVisibility + " ---- "));
		nel.append(document.createTextNode(questTitle));

		return nel;
	}

	function updateQuestionsListPage() {
		let obj = document.getElementById("questionsPageList");
		obj.innerHTML = "";
		for(quest of question_request) {
			let r = true;
			for(let tag of searchTagList) {
				if (!quest["tags"].includes(tag)) {
					r = false;
				}
			}

			if (r && quest["title"].startsWith(document.getElementById("searchTagPage").value)) {
				let el = null;

				if (isProfile) {
					if(searchDocumentId != null) {
						if (!searchDocumentQuestion.includes(quest["id"])) { // TEST IF SELECTED BY DOCUMENT AAAAAAAAAAAAAAA 
							el = createQuestionNode(quest["id"], quest["title"], quest["visibility"], "request_addQuestionToDocument('" + quest["id"] + "', searchDocumentId);", "showPopUpConfirm(\"request_destroyQuestion(loadQuestionsPage, \'" + quest["id"] + "\')\", msg_deleteQuestion);");
						}
						else {
							el = createQuestionNode(quest["id"], quest["title"], quest["visibility"], null, "showPopUpConfirm(\"request_destroyQuestion(loadQuestionsPage, \'" + quest["id"] + "\')\", msg_deleteQuestion);");
							el.style.backgroundColor = "rgb(173,216,230)";
						}
					}
					else {
						el = createQuestionNode(quest["id"], quest["title"], quest["visibility"], null, "showPopUpConfirm(\"request_destroyQuestion(loadQuestionsPage, \'" + quest["id"] + "\')\", msg_deleteQuestion);");
					}
				}
				else {
					el = createQuestionNode(quest["id"], quest["title"], quest["visibility"], null, null);
				}

				obj.appendChild(el);
			}
		}

		if (obj.innerHTML == "") {
			obj.appendChild(document.createTextNode("Aucun document pour l'instant"));
		}
	}
	
	function loadTagsPage() {
		document.getElementById("tagPageList").innerHTML = "";
		request_updateTag(() => {
			updateTagsListPage();

			let t_lt = []

			for(let d of searchTagList) {
				if (!tag_request.includes(d)) {
					t_lt.push(d);
				}
			}

			for(let d of t_lt) {
				removeTagSearch(d);
			}
		});

		changePage("tags_page");
		searchPageCallback = updateTagsListPage;
	}

	function loadQuestionsPage() {
		document.getElementById("questionsPageList").innerHTML = "";
		request_updateQuestion(() => {
			updateQuestionsListPage();
		});

		changePage("questions_page");
		searchPageCallback = updateQuestionsListPage;
	}

	function loadDocumentsPage() {
		document.getElementById("documentsPageList").innerHTML = "";
		request_updateDocument(() => {
			updateDocumentsListPage();
		});

		changePage("documents_page");
		searchPageCallback = updateDocumentsListPage;
	}

	function loadDiffusionPage(){
		document.getElementById("diffusionPageList").innerHTML = "";
		request_updateDiffusion(()=>{
			updateDiffusionListPage();
		});

		changePage("diffusion_page");
		searchPageCallback = updateDiffusionListPage;
	}

	// POP UP CONFIRM
	function PopUpConfirmTagCreation(callback) {
		request_createTag(callback, document.getElementById("tagNameCreator").value);
	}

	function PopUpConfirmQuestionCreation() {
		let qt = "QUIZZ";
		for(let d of document.getElementsByName("questionTypeCreator")) {
			if(d.checked) {
				qt = d.value;
			}
		}

		let qv = "private";
		for(let d of document.getElementsByName("questionVisibilityCreator")) {
			if(d.checked) {
				qv = d.value;
			}
		}

		request_createQuestion(loadQuestionsPage, document.getElementById("questionNameCreator").value, qt, qv);
	}

	function PopUpConfirmDocumentCreation() {
		let qv = "private";
		for(let d of document.getElementsByName("documentVisibilityCreator")) {
			if(d.checked) {
				qv = d.value;
			}
		}

		request_createDocument(loadDocumentsPage, document.getElementById("documentNameCreator").value, qv);
	}

	function PopUpConfirmDiffusionCreation(){
		let qv = "private";
		for(let d of document.getElementsByName("diffusionVisibilityCreator")) {
			if(d.checked) {
				qv = d.value;
			}
		}

		request_createDiffusion(loadDocumentsPage, document.getElementById("diffusionNameCreator").value, qv);
	}

	</script>

<!--------------------------------------------------------------------------------------------------------------------->


</head>
<body>

	<!-- barre de navigation -->
	<div id="navbar" class="navbar">
		<div style="float:left; padding-left: 10px; padding-right: 20px; font-style:bold"> {{ visit_name }}  {{ visit_surname }}  </div>
		<button class="persistentButtonOn" onclick="fadebuttonColor(this);loadDocumentsPage();">Documents</button>
		<button class="persistentButton" onclick="fadebuttonColor(this);loadQuestionsPage();">Questions</button>
		<button class="persistentButton" onclick="fadebuttonColor(this);loadTagsPage();">Tags</button>
		<button class = "persistentButton" onclick ="fadebuttonColor(this);loadDiffusionPage();">Diffusion</button>

		{% if is_connected %}
		<a href="/logout"> <button class="persistentButton" style="float:right">Déconnexion</button> </a>
		<button class="persistentButton" onclick="showPopUpProfile()" style="float:right">Mon profil</button>
		{% else %}
		<a href="/login"> <button class="persistentButton" onclick="window.location.href='/login'" style="float:right">Connexion</button> </a>
		{% endif %}
		
		<input type="text" style="display:none">
		<input type="password" style="display:none">
		<!-- barre de recherche -->
		<div class="searchbar">
			<div class="form-container">
				Qui etes vous ?
				<form method="POST" action="/login">
					<div class="form-group">
						<label>
							<input type="radio" name="user_type" value="student">
							Étudiant
						</label>
						<label>
							<input type="radio" name="user_type" value="professor">
							Professeur
						</label>
					</div>
					<button type="submit" class="btn btn-primary">Continuer</button>
				</form>
			</div> 
			
			filter by name <input autocomplete="off" id="searchTagPage" type="text">
			{% if on_profile == 'true' %}
			Document sélectionner : 
			<div id="documentSelected">
				Aucun document sélectionné pour le moment
			</div>
			{% endif %}

			TAGS : 
			<button id="searchTagButton" onclick="unrollTagList(this, 'tagListPage', 'updateHeightNavBar();');updateHeightNavBar();" class="searchTagButton"> > </button>
			<button onclick="showPopUpTag(searchTagList, false, 'replaceTagSearch(selectorTagList);updateHeightNavBar();')" class="searchTagButton"> + </button>
			<button onclick="showPopUpConfirm('replaceTagSearch([]);', msg_delAllTag)" class="searchTagButton"> del </button>
			<li id="tagListPage" class="tagListPage"></li>
		</div>
	</div>

	<!-- pop Up de profile -->
	<div id="PUWProfile" class="popUpWrapper">
		<div class="popUp">
			<button onclick="hidePopUpProfile();">quitter la page de profil</button>

			<p>nom : {{ usr_name }} </p>
			<p>prénom : {{ usr_surname }} </p>
			<p>email : {{ usr_email }} </p>
			<p><a href="/profile/{{ usr_id }}">Acceder à votre page</a></p>
			<p> identifiant utilisateur : {{ usr_id }} </p>

			<p>voulez vous changer votre mot de passe ?</p>
			<p> mot de passe actuel : <input id="pf_password" type="password"/></p>
			<p> nouveau mot de passe : <input id="pf_newpassword" type="password"/></p>
			<button onclick="request_changePassword()"> changer de mot de passe</button>
			<p id="pf_result" style="color:green"></p>
		</div>	
	</div>

	<!-- pop Up d'affichage de document -->
	<div id="PUWDocument" class="popUpWrapper">
		<div class="popUp">
			<div class="popUpButton">
				<button onclick="hidePopUpDocument()">Quitter l'onglet</button>
			</div>
			<h1 id="PUTitleDocument"></h1>
			visibilité <p id="PUVisibilityDocument"></p>
			Liste de questions <li id="PULQuestionDocument"></li>
			Liste de collaborateurs <li id="PULCollabDocument"></li>
		</div>
	</div>

	<!-- pop Up d'affichage de question -->
	<div id="PUWQuestion" class="popUpWrapper">
		<div class="popUp">
			<div class="popUpButton">
				<button onclick="hidePopUpQuestion()">Quitter l'onglet</button>
			</div>

			<h1 id="PUTitleQuestion"></h1>
			actions <div id="PUQuestionAction"></div>
			visibilité <p id="PUVisibilityQuestion"></p>
			Liste de tags <li id="PULTagsQuestion"></li>
			Liste de collaborateurs <li id="PULCollabQuestion"></li>
		</div>
	</div>

	<!-- pop Up de selection de tag -->
	<div id="PUWTag" class="popUpWrapper">
		<div class="popUp">
			<p>Veuillez sélectionner un ensemble de tag</p>
			<p> 
				TAGS sélectionner: 
				<button id="selectTagButton" onclick="unrollTagList(this, 'selectTagList', '')" class="searchTagButton"> > </button> 
				<button onclick="showPopUpConfirm('replaceTagSelect([]);', msg_delAllTag)" class="searchTagButton"> del </button>
			</p>
			<li id="selectTagList" class="tagListPage">
						jjjjjjjjjjjjj
			</li>
			rechercher <input id="selectTagPage" type="text" /> 

			<li class="tagSelectorList"></li>

			<div class="popUpSelection">
				<div class="popUpButton">
					<button id="PUCTag" onclick="" style="background-color: gray;">Confirm</button>
				</div>
				<div class="popUpButton">
					<button onclick="hidePopUpTag()" style="background-color: rgb(163, 45, 45);">Cancel</button>
				</div>
			</div>
		</div>	
	</div>

	<!-- pop Up de confirmation -->
	<div id="PUWConfirm" class="popUpWrapper">
		<div class="popUp">
			<div id="PUMConfirm" class="popUpMessage">

			</div>

			<!-- formulaire de création de document -->
			<div id="docCreator" style="display: none;">
				<div>Titre du document à créer : <input id="documentNameCreator"></div>
				
				<div>
					Visibilité du document à créer :
					<input type="radio" name="documentVisibilityCreator" value="public"> Publique
					<input type="radio" name="documentVisibilityCreator" value="restricted"> Restreinte
					<input type="radio" name="documentVisibilityCreator" value="private"> Privée
				</div>
			</div>

			<!-- formulaire de création de question -->
			<div id="questionCreator" style="display: none;">
				<div>Titre de la question à créer : <input id="questionNameCreator"></div>

				<div>
					Type de la question à créer :
					<input type="radio" name="questionTypeCreator" value="QUIZZ"> QUIZZ
				</div>
				
				<div>
					Visibilité de la question à créer :
					<input type="radio" name="questionVisibilityCreator" value="public"> Publique
					<input type="radio" name="questionVisibilityCreator" value="restricted"> Restreinte
					<input type="radio" name="questionVisibilityCreator" value="private"> Privée
				</div>
				<!---------------------------------------------------->
				<script>
					let questions = [];
			  
					function addQuestion() {
					  let question = {
						text: document.getElementById("question").value,
						options: [
						  { text: document.getElementById("option1").value, correct: document.getElementById("answer1").checked },
						  { text: document.getElementById("option2").value, correct: document.getElementById("answer2").checked },
						  { text: document.getElementById("option3").value, correct: document.getElementById("answer3").checked },
						  { text: document.getElementById("option4").value, correct: document.getElementById("answer4").checked },
						]
					  };
					  questions.push(question);
					  clearInputs();
					}
			  
					function clearInputs() {
					  document.getElementById("question").value = "";
					  document.getElementById("option1").value = "";
					  document.getElementById("option2").value = "";
					  document.getElementById("option3").value = "";
					  document.getElementById("option4").value = "";
					  document.getElementById("answer1").checked = false;
					  document.getElementById("answer2").checked = false;
					  document.getElementById("answer3").checked = false;
					  document.getElementById("answer4").checked = false;
					}
			  
					function displayQuestions() {
					  let display = document.getElementById("display");
					  display.innerHTML = "";
					  for (let i = 0; i < questions.length; i++) {
						let question = questions[i];
						display.innerHTML += "<h3>" + question.text + "</h3><ul class='list-group'>";
						for (let j = 0; j < question.options.length; j++) {
						  let option = question.options[j];
						  display.innerHTML += "<li class='list-group-item'>" + option.text;
						  if (option.correct) {
							display.innerHTML += " <span class='badge badge-success'>Correct</span>";
						  }
						  display.innerHTML += "</li>";
						  }
						display.innerHTML += "</ul>";
					  }
					}
			  
					function addOption(option) {
					  var optionHTML = `
						  <div class="form-group">
							  <div class="form-check form-check-inline">
								  <input class="form-check-input" type="checkbox" id="inlineCheckbox${optionCounter}" value="option${optionCounter}" ${option.correct ? 'checked' : ''}>
								  <label class="form-check-label" for="inlineCheckbox${optionCounter}">${option.text}</label>
							  </div>
							  <button type="button" class="btn btn-danger delete-answer bi-trash">Remove</button>
						  </div>
					  `;
					  $('#options').append(optionHTML);
				  }
				  $(document).on('click', '.delete-answer', function () {
					  $(this).closest('.form-group').remove();
				  });
				  </script>
				</head>
				<body>
				  <!--
				  <div class="container mt-5">
					<h1 class="text-center mb-5">Question Editor and Visualizer</h1>
				  -->
				  <div class ="container-fluid">
					  <div class="row">
						  <div class="col-md-2" style=" border : 2px solid #000000; background-color: rgb(108, 141, 233);">
							  <h2 class="text-center mt-5"> Editeur de questions</h2>
							  <div class="form-group">
								  <label for="question" style="margin-left: 20px;">Question:</label>
								  <input type="text" class="form-control" id="question">
							  </div>
			  
							  <div class="form-group">
								  <div class="form-check">
									  <input type="checkbox" class="form-check-input" id="answer1">
									  <label class="form-check-label" for="answer1"></label>
								  
									  <label for="option1" class="opt">Option 1:</label>
									  <button type="button" class="btn btn-danger delete-answer bi-trash">Remove</button> <br><br>
									  <input type="text" class="form-control" id="option1" placeholder="Entrez votre option...">
								  </div>    
							  </div>
			  
							  <div class="form-group">
								  <div class="form-check">
									  <input type="checkbox" class="form-check-input" id="answer2">
									  <label class="form-check-label" for="answer2"></label>
			  
								  <label for="option2" class="opt">Option 2:</label>
								  <button type="button" class="btn btn-danger delete-answer bi-trash">Remove</button> <br><br>
								  <input type="text" class="form-control" id="option2" placeholder="Entrez votre option...">
								 
								  </div>
							  </div>
							  <div class="form-group">
								  <div class="form-check">
									  <input type="checkbox" class="form-check-input" id="answer3">
									  <label class="form-check-label" for="answer3"></label>
								  <label for="option3" class="opt">Option 3:</label>
								  <button type="button" class="btn btn-danger delete-answer bi-trash">Remove</button> <br><br>
								  <input type="text" class="form-control" id="option3" placeholder="Entrez votre option...">
								  
								  </div>
							  </div>
							  <div class="form-group">
								  <div class="form-check">
									  <input type="checkbox" class="form-check-input" id="answer4">
									  <label class="form-check-label" for="answer4"></label>
								  <label for="option4" class="opt">Option 4:</label>
								  <button type="button" class="btn btn-danger delete-answer bi-trash">Remove</button> <br><br>
								  <input type="text" class="form-control" id="option4" placeholder="Entrez votre option...">
							   
								  </div>
							  </div>
					<!--<div class="text-center">-->
							  <button type="button" class="btn btn-primary mr-2" onclick="addQuestion()">Add Question</button>
							  <button type="button" class="btn btn-secondary" onclick="displayQuestions()">Display Questions</button>
							  <button type="button" class="btn btn-primary mr-2" onclick="addOption()">Add Options</button>
							  <br/>
							  <br>
						  </div>
						  <div class="col-md-2" style=" border : 2px solid #000000; background-color: rgb(90, 202, 174);">
							  <h2 class="text-center mt-5">Visualisateur</h2>
							  <div id="display"></div>
							  <div id="frame_div" style="display:none;">
								  <a href="javascript:apercuSite();">Fermer l'aperçu</a>
								  <iframe id="frame" src=""></iframe>
							  </div>
						  </div>
					  </div>
				  </div>

			</div>

			<!-- formulaire de création de tag -->
			<div id="tagCreator" style="display: none;">
				<p> Nom du tag à créer : <input id="tagNameCreator"></p>
			</div>


			<div class="popUpSelection">
				<div class="popUpButton">
					<button id="PUBConfirm" onclick="" style="background-color: gray;">Confirm</button>
				</div>
				<div class="popUpButton">
					<button onclick="hidePopUpConfirm()" style="background-color: rgb(163, 45, 45);">Cancel</button>
				</div>
			</div>
		</div>	
	</div>

	<!-- page dynamique des tags -->
	<div id="tags_page" class="dynamicpage">
		</br>
		<h3>Tags</h3>
		{% if on_profile == 'true' %}
		<button onclick="showPopUpConfirmTagCreation('PopUpConfirmTagCreation(loadTagsPage)')">Créer un nouveau tag</button>
		{% endif %}
		<li id="tagPageList"></li>
	</div>

	<!-- page dynamique des questions -->
	<div id="questions_page" class="dynamicpage">
		</br>
		<h3>Questions</h3>
		{% if on_profile == 'true' %}
		<button onclick="showPopUpConfirmQuestionCreation('PopUpConfirmQuestionCreation()')">Créer une nouvelle question</button>
		{% endif %}
		<li id="questionsPageList"></li>
	</div>

	<!-- page dynamique des documents -->
	<div id="documents_page" class="dynamicpage">
		</br>
		<h3>Documents</h3>
		{% if on_profile == 'true' %}
		<button onclick="showPopUpConfirmDocCreation('PopUpConfirmDocumentCreation()')">Créer un nouveau document</button>
		{% endif %}
		<li id="documentsPageList"></li>

	</div>

	<!-- page dynamique des diffusions-->
	<div id ="diffusion_page" class="dynamicpage">
		</br>
		<h3>Diffusion</h3>
		{% if on_profile == 'true'%}
		<button onclick = "showPopUpConfirmDiffusionCreation('PopUpConfirmDiffusionCreation()')"> Faire une diffusion de questions</button>
		{% endif %}
		<li id="diffusionPageList"></li>
	</div>

</br>
	<!-- SMOOTH ALERT -->
	<div id="smoothAlert" class="smoothAlert" style="display:none;">
		<p id="sm_message" style="font-size: large;"></p>
	</div>
</body>

<script> 
	updateHeightNavBar();
	updateTagSearchList();
	document.getElementById("searchTagPage").addEventListener("input", function (e) {
    	if (searchPageCallback != null) {
			searchPageCallback();
		}
	});

	loadDocumentsPage();
</script>
</html>